name: Security Scan

# Run on every push and PR, plus weekly schedule
on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 2 * * 0" # Sunday at 2am UTC

jobs:
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ==========================================
      # Security Check 1: Dependency Vulnerabilities
      # ==========================================
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: false # Fail build on moderate+ vulnerabilities

      # ==========================================
      # Security Check 2: Code Security Linting
      # ==========================================
      - name: Run ESLint security checks
        run: npm run lint

      # ==========================================
      # Security Check 3: TypeScript Type Safety
      # ==========================================
      - name: TypeScript type check
        run: npm run check

      # ==========================================
      # Security Check 4: Secret Scanning
      # ==========================================
      - name: Scan for secrets with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      # ==========================================
      # Security Check 5: Test Suite (includes security tests)
      # ==========================================
      - name: Run test suite
        run: npm test

      # ==========================================
      # Security Check 6: CodeQL Deep Analysis
      # ==========================================
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended # Use extended security query suite

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

      # ==========================================
      # Upload results as artifact
      # ==========================================
      - name: Generate security report
        if: always()
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## npm audit" >> security-report.md
          npm audit --json >> security-report.md || true

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-report
          path: security-report.md
          retention-days: 30
# Optional: Send notifications on failure
# Uncomment to enable Slack/email notifications
#
# - name: Notify on failure
#   if: failure()
#   uses: 8398a7/action-slack@v3
#   with:
#     status: ${{ job.status }}
#     text: 'Security scan failed!'
#     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
